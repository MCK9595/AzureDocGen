# Azure インフラ詳細設計書作成ツール 要件定義書

## 1. プロジェクト概要
### 1.1 目的
Azureインフラ開発における詳細設計書を効率的に作成するWebアプリケーションツールの開発

### 1.2 対象ユーザー
- 主要ユーザー：インフラエンジニア
- 管理者：全体管理者、プロジェクト管理者

### 1.3 システム構成
- アーキテクチャ：モノリシック（フロントエンド + バックエンド統合）
- 技術スタック：C# .NET Aspire
- 実行環境：Azure環境（ローカル開発時はAspire使用）
- データ管理：データベース

## 2. 機能要件

### 2.1 テンプレート管理機能
#### 2.1.1 テンプレート作成・編集
- 全ユーザーがテンプレート作成可能
- テンプレートの共有範囲設定
  - プロジェクト内での利用：プロジェクト管理者が設定
  - プロジェクト間での共有：全体管理者が設定
- パラメーター定義機能
  - パラメーター型の指定（文字列、数値、選択式等）
  - 必須/任意の設定
  - バリデーションルールの定義

#### 2.1.2 テンプレートバージョン管理
- バージョン履歴の保持
- 過去バージョンの参照・復元

### 2.2 プロジェクト・環境管理
#### 2.2.1 プロジェクト管理
- 1案件を1プロジェクトとして管理
- プロジェクト内で複数環境を定義（1〜N個）
  - 開発環境
  - 検証環境
  - 本番環境
  - その他カスタム環境

#### 2.2.2 依存関係管理
- 環境内でのリソース依存関係の自動解決
  - サブスクリプション、リソースグループの自動入力
  - App ServiceとApp Service Planの連携
  - VNet統合時のプライベートエンドポイント、NIC等の自動登録
- プロジェクト内共通リソースの設定機能
- 循環依存のチェック機能

### 2.3 命名規則管理
#### 2.3.1 命名規則定義
- プロジェクトレベルでの命名規則設定（全環境で参照）
- 環境レベルでの命名規則設定（特定環境のみで参照）
- 命名パターンの柔軟な定義（組織名-環境-リソース種別-連番等）

#### 2.3.2 自動命名機能
- 定義された命名規則に基づくリソース名の自動推薦

### 2.4 設計書作成機能
#### 2.4.1 パラメーター入力
- Webフォームによる入力インターフェース
- 必須項目の明示
- リアルタイムバリデーション
- 依存関係に基づく自動入力

#### 2.4.2 編集管理
- 排他制御（同じリソースの同時編集防止）
- 編集競合時の差分表示
- 差分適用の確認機能

### 2.5 ビジュアル設計インターフェース機能
#### 2.5.1 ドラッグ&ドロップ設計機能
- Azureリソースのビジュアル配置
  - ドラッグ&ドロップによるリソース配置
  - リソースアイコンのライブラリ提供
  - グリッドスナップ機能
  - 自動配置・整列機能
- リソース間接続の視覚的設定
  - コネクションラインの自動描画
  - 接続可能なリソース間のみ接続許可
  - 接続タイプの視覚的表現（ネットワーク接続、依存関係等）
  - 不正な接続の検証とエラー表示

#### 2.5.2 構成図自動生成機能
- リアルタイム構成図表示
  - 配置したリソースと接続の即時反映
  - ズーム・パン機能
  - 全体俯瞰ビューとフォーカスビュー
- 構成図のエクスポート
  - PNG/SVG形式での画像出力
  - Visio互換形式での出力
  - 構成図の設計書への自動組み込み

#### 2.5.3 ビジュアル編集機能
- リソースプロパティの直接編集
  - リソースアイコンをクリックしてプロパティパネル表示
  - ビジュアルエディタとフォームエディタの切り替え
- 一括操作機能
  - 複数リソースの選択と一括移動
  - コピー&ペースト機能
  - グループ化機能

#### 2.5.4 テンプレート構成の視覚化
- 既存テンプレートの構成図表示
- テンプレートからのビジュアル編集開始
- ビジュアル設計からのテンプレート作成

### 2.6 ワークフロー機能
#### 2.6.1 承認フロー
- 作成者 → レビューアー（複数可） → 承認
- レビューアーは1名の承認で完了
- 差し戻し機能

#### 2.6.2 承認後の修正
- メンバーによる修正：再度レビューアー承認が必要
- レビューアーによる修正：再承認不要

### 2.7 出力機能
#### 2.7.1 出力形式
- Excel形式
- PDF形式
- Markdown形式

#### 2.7.2 出力オプション
- 環境選択（チェックボックスで1〜N個選択可）
- 機密情報のマスク機能（パスワード等を****に置換）

#### 2.7.3 出力内容
- 一般的な詳細設計書フォーマットに準拠
- ビジュアル設計で作成した構成図の自動挿入
- リソース間の接続関係の図表化

### 2.8 通知機能
#### 2.8.1 アプリ内通知
- レビュー依頼通知
- 承認完了通知
- 差し戻し通知
- その他アクションが必要なイベント通知

### 2.9 データ管理機能
#### 2.9.1 削除・アーカイブ
- 設計書、テンプレートの削除機能
- アーカイブ機能（全体管理者、プロジェクト管理者が管理）

#### 2.9.2 エクスポート・インポート
- プロジェクトデータのエクスポート
- データのインポート機能

### 2.10 監査・履歴管理
#### 2.10.1 変更履歴
- 全ての変更操作の記録
- 変更内容の差分表示

#### 2.10.2 監査ログ
- ユーザー操作の記録
- アクセスログの保持

## 3. 非機能要件

### 3.1 セキュリティ要件
#### 3.1.1 認証・認可
- ユーザー認証機能（ASP.NET Core Identity）
- 階層的権限管理システム
  - システムレベル権限
    - システム管理者：全システムの管理権限
  - プロジェクトレベル権限
    - プロジェクトオーナー：プロジェクトの所有者、全権限（ユーザー管理、削除など）
    - プロジェクトマネージャー：プロジェクトの日常的な管理
    - プロジェクトレビューアー：レビューと承認権限
    - プロジェクトデベロッパー：設計書作成・編集権限
    - プロジェクトビューアー：参照のみ
  - 環境レベル権限
    - 環境管理者：特定環境の管理権限
    - 環境デベロッパー：特定環境での作業権限
    - 環境ビューアー：特定環境の参照権限

#### 3.1.2 レビューワークフロー
- プロジェクトごとのレビューアー権限管理
- 1名承認でワークフロー完了
- レビュー履歴とコメント追跡
- ワークフロー状態管理（ドラフト、レビュー中、承認済み、差し戻し、キャンセル）
- レビュー通知機能（将来実装）

#### 3.1.3 データ保護
- 機密情報の暗号化保存
- 通信の暗号化（HTTPS）

### 3.2 パフォーマンス要件
- 同時アクセスユーザー数：想定100名
- レスポンスタイム：3秒以内（通常操作）

### 3.3 可用性要件
- Azure環境での高可用性構成
- データのバックアップ機能

### 3.4 保守性要件
- ログ出力機能
- エラーハンドリング
- 監視機能の実装

### 3.5 テスト要件
#### 3.5.1 単体テスト
- 各機能開発時に単体テストを実装
- テストカバレッジ目標：80%以上
- テストフレームワーク：xUnit、NUnit、MSTestのいずれか
- モックフレームワーク：Moq、NSubstituteなど
- 以下の観点でテストを実施
  - 正常系・異常系の動作確認
  - 境界値テスト
  - 例外処理の確認
  - ビジネスロジックの検証

#### 3.5.2 結合テスト
- .NET AspireのDistributedApplicationTestingBuilderを使用
- Aspireの機能を活用した結合テストの実施
- 以下の項目をテスト
  - サービス間の通信
  - データベース接続とCRUD操作
  - 認証・認可の動作
  - エンドツーエンドのシナリオテスト
- テスト環境でのコンテナ起動と連携確認
- ヘルスチェックエンドポイントの動作確認

#### 3.5.3 テスト実行タイミング
- 開発時：機能実装と並行してテストを作成（テスト駆動開発を推奨）
- プルリクエスト時：自動テスト実行
- CI/CDパイプライン：ビルド時に全テスト実行
- リリース前：回帰テストの実施

## 4. 制約事項
- IaCツールとの連携は現時点では不要
- 既存リソースからのパラメーター取り込み機能は不要
- マイクロサービスアーキテクチャは採用しない

## 5. 今後の拡張性
- 将来的なIaCツール連携の可能性を考慮した設計
- Azureリソースタイプの追加に対応できる柔軟な設計